-- Compara Lancto x Emissoes

SELECT /*+OPTIMIZER_FEATURES_ENABLE('11.2.0.4')*/ 
       NUMERONF, X.SEQPRODUTO, DESCCOMPLETA, VL VLR_LANCTO, VE VLR_EMITIDO, VE - VL DIF, QTD FROM (
SELECT LISTAGG(NUMERODF, ', ') WITHIN GROUP (ORDER BY NUMERODF) NUMERONF, A.SEQPRODUTO, (SELECT NVL(ROUND(SUM(Z.VALORLANCTOBRT * QTDLANCTO),2),0)
               FROM FATO_PERDA Z
              WHERE Z.NROEMPRESA =  14
                AND CODGERALOPER IN (20,30,33,34,35,41,46,47,62,63,66,90,91,110,111,112,113,114,263)
                AND Z.DTAOPERACAO BETWEEN DATE '2024-08-01' AND DATE '2024-08-31'
                AND Z.SEQPRODUTO = A.SEQPRODUTO) VL, SUM(VLRITEM) VE, SUM(QUANTIDADE) QTD
                
  FROM MFLV_BASEDFITEM A
    
 WHERE A.NUMERODF IN (42318,42319,42320,42322,42287,42289,42290,42291,42292,42293,42296,42303,42326)
   AND A.DTAEMISSAO BETWEEN DATE '2024-09-01' AND DATE '2024-09-20'
   AND CODGERALOPER IN (806,807)
   AND NROEMPRESA = 14

GROUP BY  A.SEQPRODUTO) X INNER JOIN MAP_PRODUTO P ON P.SEQPRODUTO = X.SEQPRODUTO

 WHERE 1=1 AND VL != VE
