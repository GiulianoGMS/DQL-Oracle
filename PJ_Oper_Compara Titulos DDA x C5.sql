ALTER SESSION SET current_schema = CONSINCO;

SELECT GE.NOMERAZAO||' - '||GE.SEQPESSOA Fornecedor,
       CASE WHEN LPAD(DDA.NROCNPJCPF,12,0)||LPAD(DDA.DIGCNPJCPF,2,0) IN 
         (SELECT LPAD(GE.NROCGCCPF,12,0)||LPAD(GE.DIGCGCCPF,2,0) FROM GE_PESSOA) THEN 'S' ELSE 'N' END CNPJ,
       CASE WHEN F.DTAVENCIMENTO = DDA.DTAVENCIMENTO AND (F.VLRORIGINAL - FC.VLRDESCCONTRATO) = (DDA.VALORDOCUMENTO - DDA.VALORDESCONTO1) AND DDA.NRODOCUMENTO LIKE ('%'||F.NRODOCUMENTO||'%')                 THEN '1' 
            WHEN F.DTAVENCIMENTO = DDA.DTAVENCIMENTO AND (F.VLRORIGINAL - FC.VLRDESCCONTRATO) = (DDA.VALORDOCUMENTO - VALORDESCONTO1 - VALORABATIMENTO)AND DDA.NRODOCUMENTO LIKE ('%'||F.NRODOCUMENTO||'%')    THEN '2'
            WHEN F.DTAVENCIMENTO = DDA.DTAVENCIMENTO AND((F.VLRORIGINAL - FC.VLRDESCCONTRATO) = (DDA.VALORDOCUMENTO - DDA.VALORDESCONTO1))AND DDA.NRODOCUMENTO LIKE ('%'||F.NRODOCUMENTO||'%')                 THEN '3'
            WHEN F.DTAPROGRAMADA = DDA.DTAVENCIMENTO AND DDA.NRODOCUMENTO LIKE (F.NRODOCUMENTO||'%') AND FC.VLRDESCCONTRATO = DDA.VALORDESCONTO1                                                               THEN '4' 
            WHEN F.DTAPROGRAMADA = DDA.DTAVENCIMENTO AND (F.VLRORIGINAL) = DDA.VALORDOCUMENTO AND DDA.NRODOCUMENTO LIKE ('%'||F.NRODOCUMENTO||'%') AND
                 (CASE WHEN FC.VLRDESCCONTRATO IS NULL THEN '0' ELSE TO_CHAR(FC.VLRDESCCONTRATO) END) = (DDA.VALORDESCONTO1 + VALORABATIMENTO)                                                                 THEN '5'
            WHEN F.DTAVENCIMENTO = DDA.DTAVENCIMENTO AND (F.VLRORIGINAL - FC.VLRDESCCONTRATO) = DDA.VALORCOMDESCONTO AND GE.NOMERAZAO LIKE ('%'||DDA.DESCFORNECEDOR||'%')                                      THEN '6' 
            WHEN F.DTAVENCIMENTO = DDA.DTAVENCIMENTO AND (F.VLRORIGINAL - FC.VLRDESCCONTRATO) = (DDA.VALORDOCUMENTO - (DDA.VALORDESCONTO1 + DDA.VALORABATIMENTO))AND GE.NOMERAZAO LIKE ('%'||REGEXP_SUBSTR(DDA.DESCFORNECEDOR, '(\S*)(\s)')||'%') THEN '7'
           
       ELSE NULL END VLD,
                
       F.NRODOCUMENTO DOC_C5, DDA.NRODOCUMENTO, FC.SEQTITULO
       
FROM FI_TITULO F INNER JOIN FI_ESPECIE FI ON F.CODESPECIE = FI.CODESPECIE AND F.NROEMPRESAMAE = FI.NROEMPRESAMAE
                 INNER JOIN GE_PESSOA  GE ON F.SEQPESSOA  = GE.SEQPESSOA  
                 INNER JOIN FI_COMPLTITULO  FC ON F.SEQTITULO = FC.SEQTITULO
  /*SEQ*/           LEFT JOIN CONSINCO.FIV_DDATITULOSBUSCA DDA ON
/*VALIDADOR*/     --(TO_CHAR(LPAD((REGEXP_SUBSTR (DDA.NRODOCUMENTO,'[^-]+', 1, 1)),20,0))) = (TO_CHAR(LPAD(F.NRODOCUMENTO,20,0)))
   /*1*/         F.DTAVENCIMENTO = DDA.DTAVENCIMENTO AND (F.VLRORIGINAL - FC.VLRDESCCONTRATO) = (DDA.VALORDOCUMENTO - DDA.VALORDESCONTO1)
                    AND DDA.NRODOCUMENTO LIKE ('%'||F.NRODOCUMENTO||'%')
   /*2*/         OR F.DTAVENCIMENTO = DDA.DTAVENCIMENTO AND (F.VLRORIGINAL - FC.VLRDESCCONTRATO) = (DDA.VALORDOCUMENTO - VALORDESCONTO1 - VALORABATIMENTO)
                 AND DDA.NRODOCUMENTO LIKE ('%'||F.NRODOCUMENTO||'%')
   /*3*/         OR F.DTAVENCIMENTO = DDA.DTAVENCIMENTO AND  ((F.VLRORIGINAL - FC.VLRDESCCONTRATO) = (DDA.VALORDOCUMENTO - DDA.VALORDESCONTO1))
                 AND DDA.NRODOCUMENTO LIKE ('%'||F.NRODOCUMENTO||'%') 
   /*4*/         OR F.DTAPROGRAMADA = DDA.DTAVENCIMENTO AND DDA.NRODOCUMENTO LIKE (F.NRODOCUMENTO||'%')
                 AND FC.VLRDESCCONTRATO = DDA.VALORDESCONTO1 
   /*5*/         OR F.DTAPROGRAMADA = DDA.DTAVENCIMENTO AND (F.VLRORIGINAL) = DDA.VALORDOCUMENTO
                 AND DDA.NRODOCUMENTO LIKE ('%'||F.NRODOCUMENTO||'%') AND
                 (CASE WHEN FC.VLRDESCCONTRATO IS NULL THEN '0' ELSE TO_CHAR(FC.VLRDESCCONTRATO) END) = (DDA.VALORDESCONTO1 + VALORABATIMENTO)
   /*6*/         OR F.DTAVENCIMENTO = DDA.DTAVENCIMENTO AND (F.VLRORIGINAL - FC.VLRDESCCONTRATO) = DDA.VALORCOMDESCONTO 
                 AND GE.NOMERAZAO LIKE ('%'||DDA.DESCFORNECEDOR||'%')
   /*7*/         OR F.DTAVENCIMENTO = DDA.DTAVENCIMENTO AND (F.VLRORIGINAL - FC.VLRDESCCONTRATO) = (DDA.VALORDOCUMENTO - (DDA.VALORDESCONTO1 + DDA.VALORABATIMENTO))
                 AND GE.NOMERAZAO LIKE ('%'||REGEXP_SUBSTR(DDA.DESCFORNECEDOR, '(\S*)(\s)')||'%')
   /*8*/        
                 
                 
WHERE F.OBRIGDIREITO     = 'O'
  AND F.ABERTOQUITADO    = 'A' 
  AND FI.TIPOESPECIE     = 'T' 
  AND F.ABERTOQUITADO   != 'Q'
  AND F.SITUACAO        != 'S'  
  AND NVL(F.SUSPLIB,'L') = 'L'  
  AND FC.CODBARRA         IS NULL     
                   
  AND F.DTAVENCIMENTO BETWEEN DATE '2022-05-01' AND DATE '2022-05-10' 
  AND F.NROEMPRESA        IN (50) 
  
ORDER BY 1,3; 
