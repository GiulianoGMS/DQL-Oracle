SELECT NVL( A.SEQPESSOA, 0) || ' - ' || A.NOMERAZAO PESSOA, A.NROEMPRESA,
       A.NROBANCO, DESCTOTASCONTAS, CODESPECIE ESPECIE,
       NVL( A.NROTITULO, 0) || '-' ||  A.SERIETITULO  || '/' || A.NROPARCELA TITULO,
       TO_CHAR(A.DTAEMISSAO, 'DD/MM/YYYY') DTAEMISSAO, 
       TO_CHAR(B.DTACONTABILIZA, 'DD/MM/YYYY') DTA_OP_QUITACAO, 
       TO_CHAR(A.VLRDSCFINANC, 'FM999G999G990D90', 'NLS_NUMERIC_CHARACTERS='',.''') VLR_DESCONTO, 
       TO_CHAR(VLRORIGINAL,    'FM999G999G990D90', 'NLS_NUMERIC_CHARACTERS='',.''')  VLR_ORIGINAL, 
       TO_CHAR(VLRPAGO,        'FM999G999G990D90', 'NLS_NUMERIC_CHARACTERS='',.''') VLR_PAGO, 
       TO_CHAR((A.VLRPAGO + A.VLRJUROS + A.VLRMULTA - A.VLRDESCFIN - A.VLRCOMPENSACAO - A.VLRTXADMINISTRATIVA), 'FM999G999G990D90', 'NLS_NUMERIC_CHARACTERS='',.''')  VLRLIQUIDO,
       TO_CHAR(B.VLROPERACAO, 'FM999G999G990D90', 'NLS_NUMERIC_CHARACTERS='',.''') VLR_OPERACAO
  
 FROM FIV_TITULOS_QUITADOS A LEFT JOIN FI_TITOPERACAO B ON A.SEQTITULO = B.SEQTITULO

WHERE A.OBRIGDIREITO = DECODE(:LS1, 'Obrigação','O','Direito','D')
  AND A.CODESPECIE   IN (SELECT DISTINCT UPPER(TRIM(REGEXP_SUBSTR('#LT1', '[^,]+', 1, LEVEL))) AS SEPARA_ESPECIE
                           FROM DUAL
                        CONNECT BY REGEXP_SUBSTR('#LT1', '[^,]+', 1, LEVEL) IS NOT NULL) /* SEPARA ESPECIE POR LINHA */
  AND B.DTAOPERACAO  BETWEEN :DT1 AND :DT2 
  AND A.DTAEMISSAO   BETWEEN :DT3 AND :DT4                         
  AND A.CODIGOFATOR  IS NULL  
  AND A.NROBANCO     IN ( 1, 310, 11, 422, 341, 33, 237, 900 )
  AND A.NROEMPRESA   IN (#LS2)
  AND B.OPCANCELADA IS NULL
  
  AND B.CODOPERACAO  IN (2, 3, 4, 5, 6, 11, 17, 19, 20, 23, 24, 25, 28, 29, 30, 38, 39, 42, 43, 46, 49, 58, 61, 67, 68, 70, 
                         76, 77, 95, 97, 98, 105, 106, 107, 108, 112, 113, 114, 120, 121, 136, 138, 148, 150, 151, 153, 154, 
                         155, 172, 180, 181, 182, 184, 185, 191, 194, 196, 197, 203, 204, 205, 208, 210, 211, 213, 214, 217, 
                         218, 220, 221, 222, 223, 224, 228, 229, 230, 231, 233, 235, 299, 415, 418, 811, 935 )
---------------------------------
-- V2 - Alteração no filtro de data de acordo com tipo obrigação/direito
---------------------------------

SELECT NVL( A.SEQPESSOA, 0) || ' - ' || A.NOMERAZAO PESSOA, A.NROEMPRESA,
       A.NROBANCO, DESCTOTASCONTAS, A.CODESPECIE ESPECIE, A.SEQTITULO,
       NVL( A.NROTITULO, 0) || '/' ||  A.SERIETITULO  || '-' || A.NROPARCELA TITULO,
       TO_CHAR(A.DTAEMISSAO, 'DD/MM/YYYY') DTAEMISSAO, 
       TO_CHAR(B.DTACONTABILIZA, 'DD/MM/YYYY') DTA_OP_QUITACAO, 
       TO_CHAR(A.VLRDSCFINANC, 'FM999G999G990D90', 'NLS_NUMERIC_CHARACTERS='',.''') VLR_DESCONTO, 
       TO_CHAR(A.VLRORIGINAL,    'FM999G999G990D90', 'NLS_NUMERIC_CHARACTERS='',.''') VLR_ORIGINAL, 
       TO_CHAR(A.VLRPAGO,        'FM999G999G990D90', 'NLS_NUMERIC_CHARACTERS='',.''') VLR_PAGO, 
       TO_CHAR((A.VLRPAGO + A.VLRJUROS + A.VLRMULTA - A.VLRDESCFIN - A.VLRCOMPENSACAO - A.VLRTXADMINISTRATIVA), 'FM999G999G990D90', 'NLS_NUMERIC_CHARACTERS='',.''')  VLRLIQUIDO,
       TO_CHAR(B.VLROPERACAO, 'FM999G999G990D90', 'NLS_NUMERIC_CHARACTERS='',.''') VLR_OPERACAO
  
 FROM FIV_TITULOS_QUITADOS A LEFT JOIN FI_TITOPERACAO B ON A.SEQTITULO = B.SEQTITULO
                             INNER JOIN FI_TITULO C ON A.SEQTITULO = C.SEQTITULO

WHERE A.OBRIGDIREITO = DECODE(:LS1, 'Obrigação','O','Direito','D')
  AND A.CODESPECIE   IN (SELECT DISTINCT UPPER(TRIM(REGEXP_SUBSTR('#LT1', '[^,]+', 1, LEVEL))) AS SEPARA_ESPECIE
                           FROM DUAL
                        CONNECT BY REGEXP_SUBSTR('#LT1', '[^,]+', 1, LEVEL) IS NOT NULL) /* SEPARA ESPECIE POR LINHA */
  AND B.DTAOPERACAO  BETWEEN :DT1 AND :DT2 
  AND(A.OBRIGDIREITO = 'D' AND A.DTAEMISSAO BETWEEN :DT3 AND :DT4 OR A.OBRIGDIREITO = 'O' AND A.DTAMOVIMENTO BETWEEN :DT3 AND :DT4)
  AND A.CODIGOFATOR  IS NULL  
  AND A.NROBANCO     IN ( 1, 310, 11, 422, 341, 33, 237, 900 )
  AND A.NROEMPRESA   IN (#LS2)
  AND B.OPCANCELADA  IS NULL
  AND B.CODOPERACAO  IN (2, 3, 4, 5, 6, 11, 17, 19, 20, 23, 24, 25, 28, 29, 30, 38, 39, 42, 43, 46, 49, 58, 61, 67, 68, 70, 
                         76, 95, 97, 98, 105, 106, 107, 108, 112, 113, 114, 120, 121, 136, 138, 148, 150, 151, 153, 154, 
                         155, 172, 180, 181, 182, 184, 185, 191, 194, 196, 197, 203, 204, 205, 208, 210, 211, 213, 214, 217, 
                         218, 220, 221, 222, 223, 224, 228, 229, 230, 231, 233, 235, 299, 415, 418, 811, 935)
                         

